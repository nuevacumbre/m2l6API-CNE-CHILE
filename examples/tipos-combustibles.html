<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API CNE - Ejemplo: Tipos de Combustible</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="container">
        <header class="my-4">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="text-primary">‚õΩ Ejemplo: Tipos de Combustible</h1>
                <a href="../index.html" class="btn btn-outline-secondary">‚Üê Volver al Inicio</a>
            </div>
            <p class="text-muted">Demostraci√≥n del endpoint /api/v4/combustible/vehicular/tiposcombustibles</p>
        </header>

        <!-- Estado de Autenticaci√≥n -->
        <div class="estado-autenticacion mb-4"></div>

        <!-- Ejemplo de C√≥digo -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">C√≥digo de Ejemplo</h5>
            </div>
            <div class="card-body">
                <pre><code>// Configuraci√≥n de la llamada AJAX con jQuery
var settings = {
    "url": "https://api.cne.cl/api/v4/combustible/vehicular/tiposcombustibles",
    "method": "GET",
    "timeout": 0,
    "headers": {
        "Authorization": "Bearer &lt;token&gt;"
    }
};

// Realizar la llamada
$.ajax(settings).done(function (response) {
    console.log(response);
    // Procesar la respuesta aqu√≠
});</code></pre>
                
                <div class="mt-3">
                    <h6>Estructura de Respuesta Real:</h6>
                    <pre class="bg-light p-3 rounded"><code>[
  {
    "nombre_combustible": "Gasolina 93"
  },
  {
    "nombre_combustible": "Gasolina 95" 
  },
  {
    "nombre_combustible": "Gasolina 97"
  },
  {
    "nombre_combustible": "Petroleo Diesel"
  },
  {
    "nombre_combustible": "Kerosene"
  },
  {
    "nombre_combustible": "GNC"
  },
  {
    "nombre_combustible": "GLP Vehicular"
  }
]</code></pre>
                </div>
            </div>
        </div>

        <!-- Controles -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <p class="mb-0">Carga el cat√°logo completo de tipos de combustible vehicular</p>
                    </div>
                    <div class="col-md-4">
                        <button id="btn-cargar" class="btn btn-primary w-100" onclick="cargarTiposCombustible()">
                            Cargar Tipos de Combustible
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <label for="buscar-combustible" class="form-label">Buscar combustible:</label>
                        <input type="text" id="buscar-combustible" class="form-control" 
                               placeholder="Escribe para filtrar..." onkeyup="filtrarCombustibles()">
                    </div>
                    <div class="col-md-6">
                        <label for="filtro-categoria" class="form-label">Filtrar por categor√≠a:</label>
                        <select id="filtro-categoria" class="form-select" onchange="filtrarCombustibles()">
                            <option value="">Todas las categor√≠as</option>
                            <option value="Gasolina">Gasolina</option>
                            <option value="Diesel">Diesel</option>
                            <option value="Kerosene">Kerosene</option>
                            <option value="GNC">GNC</option>
                            <option value="GLP">GLP</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados -->
        <div id="resultados-combustibles" class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Resultados</h5>
                <span id="contador-combustibles" class="badge bg-light text-dark">0 tipos</span>
            </div>
            <div class="card-body">
                <div id="contenido-combustibles" class="text-center text-muted">
                    <p>Haz clic en "Cargar Tipos de Combustible" para ver los datos</p>
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div id="estadisticas-combustibles" class="card mt-4 d-none">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">üìà Estad√≠sticas por Categor√≠a</h6>
            </div>
            <div class="card-body">
                <div class="row" id="stats-content">
                    <!-- Las estad√≠sticas se generar√°n aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- Informaci√≥n Adicional -->
        <div class="card mt-4">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">üìä Informaci√≥n del Endpoint</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Caracter√≠sticas:</h6>
                        <ul>
                            <li><strong>M√©todo:</strong> GET</li>
                            <li><strong>Autenticaci√≥n:</strong> Requerida (Bearer Token)</li>
                            <li><strong>Versi√≥n API:</strong> v4</li>
                            <li><strong>Tipo de datos:</strong> Cat√°logo de combustibles vehiculares</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Campo disponible:</h6>
                        <ul>
                            <li><code>nombre_combustible</code> - Nombre del tipo de combustible</li>
                        </ul>
                        <div class="alert alert-info mt-3">
                            <small>
                                <strong>üí° Nota:</strong> Este endpoint proporciona el cat√°logo maestro de tipos de combustible 
                                vehicular disponibles en Chile. Los c√≥digos abreviados (93, 95, 97, DI) se usan en otros endpoints.
                            </small>
                        </div>
                    </div>
                </div>
                
                <h6 class="mt-4">Relaci√≥n con otros endpoints:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre Completo</th>
                                <th>C√≥digo en Precios</th>
                                <th>Categor√≠a</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Gasolina 93</td>
                                <td><code>93</code> o <code>A93</code></td>
                                <td><span class="badge bg-primary">Gasolina</span></td>
                            </tr>
                            <tr>
                                <td>Gasolina 95</td>
                                <td><code>95</code> o <code>A95</code></td>
                                <td><span class="badge bg-primary">Gasolina</span></td>
                            </tr>
                            <tr>
                                <td>Gasolina 97</td>
                                <td><code>97</code> o <code>A97</code></td>
                                <td><span class="badge bg-primary">Gasolina</span></td>
                            </tr>
                            <tr>
                                <td>Petroleo Diesel</td>
                                <td><code>DI</code> o <code>ADI</code></td>
                                <td><span class="badge bg-success">Diesel</span></td>
                            </tr>
                            <tr>
                                <td>Kerosene</td>
                                <td><code>KER</code></td>
                                <td><span class="badge bg-warning">Kerosene</span></td>
                            </tr>
                            <tr>
                                <td>GNC</td>
                                <td><code>GNC</code></td>
                                <td><span class="badge bg-info">Gas Natural</span></td>
                            </tr>
                            <tr>
                                <td>GLP Vehicular</td>
                                <td><code>GLP</code></td>
                                <td><span class="badge bg-secondary">Gas Licuado</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../app.js"></script>
    <script>
        let combustiblesData = [];

        $(function() {
            actualizarEstadoAutenticacion();
        });

        function cargarTiposCombustible() {
            const $contenido = $('#contenido-combustibles');
            const $contador = $('#contador-combustibles');
            const $estadisticas = $('#estadisticas-combustibles');
            const $statsContent = $('#stats-content');
            
            if (!API_TOKEN) {
                $contenido.html(`
                    <div class="alert alert-warning">
                        <h6>Autenticaci√≥n requerida</h6>
                        <p>Necesitas un token v√°lido para acceder a este endpoint.</p>
                        <a href="../login.html" class="btn btn-sm btn-primary">Iniciar Sesi√≥n</a>
                    </div>
                `);
                return;
            }

            $contenido.html('<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Cargando tipos de combustible...</p></div>');

            makeCNE_API_Call("https://api.cne.cl/api/v4/combustible/vehicular/tiposcombustibles")
                .done(function(response) {
                    combustiblesData = response;
                    mostrarCombustibles(response);
                    generarEstadisticas(response);
                    $estadisticas.removeClass('d-none');
                })
                .fail(function(jqXHR) {
                    let mensaje = '';
                    if (jqXHR.status === 401) {
                        mensaje = 'Token inv√°lido o expirado. <a href="../login.html" class="alert-link">Iniciar sesi√≥n nuevamente</a>.';
                    } else {
                        mensaje = `Error ${jqXHR.status}: ${jqXHR.statusText}`;
                    }
                    
                    $contenido.html(`
                        <div class="alert alert-danger">
                            <h6>Error al cargar tipos de combustible</h6>
                            <p>${mensaje}</p>
                        </div>
                    `);
                    $contador.text('0 tipos');
                    $estadisticas.addClass('d-none');
                });
        }

        function mostrarCombustibles(combustibles) {
            const $contenido = $('#contenido-combustibles');
            const $contador = $('#contador-combustibles');
            
            let html = '';
            let contador = 0;
            
            if (Array.isArray(combustibles) && combustibles.length > 0) {
                html = '<div class="row">';
                
                $.each(combustibles, function(i, combustible) {
                    const nombre = combustible.nombre_combustible || 'Nombre no disponible';
                    const categoria = determinarCategoria(nombre);
                    const codigo = obtenerCodigoCombustible(nombre);
                    const icono = obtenerIconoCategoria(categoria);
                    
                    contador++;
                    
                    html += `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100 combustible-card border-start border-4 border-${obtenerColorCategoria(categoria)}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title text-${obtenerColorCategoria(categoria)}">
                                            ${icono} ${nombre}
                                        </h5>
                                        <span class="badge bg-${obtenerColorCategoria(categoria)}">
                                            ${categoria}
                                        </span>
                                    </div>
                                    <p class="card-text">
                                        <strong>C√≥digo:</strong> <code>${codigo}</code><br>
                                        <strong>Tipo:</strong> ${obtenerDescripcionTipo(categoria)}<br>
                                        <strong>Uso:</strong> Vehicular
                                    </p>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> ID: ${i + 1}
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html = '<div class="alert alert-warning">No se encontraron tipos de combustible o el token es inv√°lido.</div>';
            }
            
            $contenido.html(html);
            $contador.text(contador + ' tipos');
        }

        function determinarCategoria(nombre) {
            const nombreLower = nombre.toLowerCase();
            
            if (nombreLower.includes('gasolina')) return 'Gasolina';
            if (nombreLower.includes('diesel')) return 'Diesel';
            if (nombreLower.includes('kerosene')) return 'Kerosene';
            if (nombreLower.includes('gnc')) return 'GNC';
            if (nombreLower.includes('glp')) return 'GLP';
            
            return 'Otros';
        }

        function obtenerCodigoCombustible(nombre) {
            const codigos = {
                'gasolina 93': '93',
                'gasolina 95': '95', 
                'gasolina 97': '97',
                'petroleo diesel': 'DI',
                'kerosene': 'KER',
                'gnc': 'GNC',
                'glp vehicular': 'GLP'
            };
            
            return codigos[nombre.toLowerCase()] || 'N/A';
        }

        function obtenerIconoCategoria(categoria) {
            const iconos = {
                'Gasolina': '‚õΩ',
                'Diesel': 'üöõ',
                'Kerosene': 'üî•',
                'GNC': 'üí®',
                'GLP': '‚ö°',
                'Otros': 'üîß'
            };
            
            return iconos[categoria] || '‚õΩ';
        }

        function obtenerColorCategoria(categoria) {
            const colores = {
                'Gasolina': 'primary',
                'Diesel': 'success', 
                'Kerosene': 'warning',
                'GNC': 'info',
                'GLP': 'secondary',
                'Otros': 'dark'
            };
            
            return colores[categoria] || 'dark';
        }

        function obtenerDescripcionTipo(categoria) {
            const descripciones = {
                'Gasolina': 'Combustible para motores de combusti√≥n',
                'Diesel': 'Combustible para motores di√©sel',
                'Kerosene': 'Combustible para calefacci√≥n y aviaci√≥n',
                'GNC': 'Gas Natural Comprimido',
                'GLP': 'Gas Licuado de Petr√≥leo',
                'Otros': 'Otros tipos de combustible'
            };
            
            return descripciones[categoria] || 'Combustible vehicular';
        }

        function filtrarCombustibles() {
            const textoFiltro = $('#buscar-combustible').val().toLowerCase().trim();
            const categoriaFiltro = $('#filtro-categoria').val();
            
            if (!textoFiltro && !categoriaFiltro) {
                mostrarCombustibles(combustiblesData);
                generarEstadisticas(combustiblesData);
                return;
            }

            const filtrados = combustiblesData.filter(combustible => {
                const nombre = combustible.nombre_combustible || '';
                const categoria = determinarCategoria(nombre);
                
                // Filtro por texto
                if (textoFiltro && !nombre.toLowerCase().includes(textoFiltro)) {
                    return false;
                }
                
                // Filtro por categor√≠a
                if (categoriaFiltro && categoria !== categoriaFiltro) {
                    return false;
                }
                
                return true;
            });

            mostrarCombustibles(filtrados);
            generarEstadisticas(filtrados);
        }

        function generarEstadisticas(combustibles) {
            const estadisticas = {};
            
            combustibles.forEach(combustible => {
                const nombre = combustible.nombre_combustible || '';
                const categoria = determinarCategoria(nombre);
                
                if (!estadisticas[categoria]) {
                    estadisticas[categoria] = 0;
                }
                estadisticas[categoria]++;
            });

            let statsHtml = '';
            
            Object.entries(estadisticas).forEach(([categoria, cantidad]) => {
                statsHtml += `
                    <div class="col-md-3 mb-3">
                        <div class="card bg-${obtenerColorCategoria(categoria)} text-white text-center">
                            <div class="card-body py-3">
                                <h4>${cantidad}</h4>
                                <p class="mb-0">${categoria}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#stats-content').html(statsHtml);
        }

        // Tambi√©n actualizamos la funci√≥n del dashboard
        function cargarResumenCombustibles() {
            const token = localStorage.getItem('cne_api_token');
            if (!token) return;

            $.ajax({
                url: "https://api.cne.cl/api/v4/combustible/vehicular/tiposcombustibles",
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
            .done(function(response) {
                $('#contador-combustibles').text(response.length || 0);
                
                let html = '';
                if (Array.isArray(response) && response.length > 0) {
                    html = '<div class="d-flex flex-wrap gap-2">';
                    $.each(response, function(i, combustible) {
                        const nombre = combustible.nombre_combustible || 'N/A';
                        const categoria = determinarCategoria(nombre);
                        html += `
                            <span class="badge bg-${obtenerColorCategoria(categoria)} p-2">
                                ${obtenerIconoCategoria(categoria)} ${nombre}
                            </span>
                        `;
                    });
                    html += '</div>';
                } else {
                    html = '<p class="text-warning">No se pudieron cargar los tipos de combustible</p>';
                }
                $('#vista-combustibles').html(html);
            })
            .fail(function() {
                $('#contador-combustibles').text('0');
                $('#vista-combustibles').html('<p class="text-danger">Error al cargar tipos de combustible</p>');
            });
        }
    </script>
</body>
</html>