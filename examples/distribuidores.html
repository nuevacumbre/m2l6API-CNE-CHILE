<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API CNE - Ejemplo: Distribuidores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="container">
        <header class="my-4">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="text-primary">üè¢ Ejemplo: Distribuidores de Combustible</h1>
                <a href="../index.html" class="btn btn-outline-secondary">‚Üê Volver al Inicio</a>
            </div>
            <p class="text-muted">Demostraci√≥n del endpoint /api/v4/combustible/vehicular/distribuidores</p>
        </header>

        <!-- Estado de Autenticaci√≥n -->
        <div class="estado-autenticacion mb-4"></div>

        <!-- Ejemplo de C√≥digo -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">C√≥digo de Ejemplo</h5>
            </div>
            <div class="card-body">
                <pre><code>// Configuraci√≥n de la llamada AJAX con jQuery
var settings = {
    "url": "https://api.cne.cl/api/v4/combustible/vehicular/distribuidores",
    "method": "GET",
    "timeout": 0,
    "headers": {
        "Authorization": "Bearer &lt;token&gt;"
    }
};

// Realizar la llamada
$.ajax(settings).done(function (response) {
    console.log(response);
    // Procesar la respuesta aqu√≠
});</code></pre>
                
                <div class="mt-3">
                    <h6>Estructura de Respuesta Real:</h6>
                    <pre class="bg-light p-3 rounded"><code>[
  {
    "nombre_distribuidor": "COPEC"
  },
  {
    "nombre_distribuidor": "SHELL"
  },
  {
    "nombre_distribuidor": "TERPEL"
  }
]</code></pre>
                </div>
            </div>
        </div>

        <!-- Controles -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <p class="mb-0">Carga la lista completa de distribuidores registrados</p>
                    </div>
                    <div class="col-md-4">
                        <button id="btn-cargar" class="btn btn-primary w-100" onclick="cargarDistribuidores()">
                            Cargar Distribuidores
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- B√∫squeda -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <label for="buscar-distribuidor" class="form-label">Buscar distribuidor:</label>
                        <input type="text" id="buscar-distribuidor" class="form-control" 
                               placeholder="Escribe para filtrar..." onkeyup="filtrarDistribuidores()">
                    </div>
                    <div class="col-md-4">
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="ordenar-alfabetico" onchange="cargarDistribuidores()">
                            <label class="form-check-label" for="ordenar-alfabetico">
                                Ordenar alfab√©ticamente
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados -->
        <div id="resultados-distribuidores" class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Resultados</h5>
                <span id="contador-distribuidores" class="badge bg-light text-dark">0 distribuidores</span>
            </div>
            <div class="card-body">
                <div id="contenido-distribuidores" class="text-center text-muted">
                    <p>Haz clic en "Cargar Distribuidores" para ver los datos</p>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n Adicional -->
        <div class="card mt-4">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">üìä Informaci√≥n del Endpoint</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Caracter√≠sticas:</h6>
                        <ul>
                            <li><strong>M√©todo:</strong> GET</li>
                            <li><strong>Autenticaci√≥n:</strong> Requerida (Bearer Token)</li>
                            <li><strong>Versi√≥n API:</strong> v4</li>
                            <li><strong>Tipo de datos:</strong> Lista de empresas distribuidoras</li>
                            <li><strong>Preflight:</strong> OPTIONS (CORS)</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Campo disponible:</h6>
                        <ul>
                            <li><code>nombre_distribuidor</code> - Nombre de la empresa distribuidora</li>
                        </ul>
                        <div class="alert alert-info mt-3">
                            <small>
                                <strong>‚ö†Ô∏è Nota:</strong> Este endpoint solo devuelve el nombre del distribuidor. 
                                Para informaci√≥n m√°s detallada, consulta la documentaci√≥n oficial de la API CNE.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../app.js"></script>
    <script>
        let distribuidoresData = []; // Variable global para almacenar los datos

        $(function() {
            actualizarEstadoAutenticacion();
        });

        function cargarDistribuidores() {
            const $contenido = $('#contenido-distribuidores');
            const $contador = $('#contador-distribuidores');
            
            if (!API_TOKEN) {
                $contenido.html(`
                    <div class="alert alert-warning">
                        <h6>Autenticaci√≥n requerida</h6>
                        <p>Necesitas un token v√°lido para acceder a este endpoint.</p>
                        <a href="../login.html" class="btn btn-sm btn-primary">Iniciar Sesi√≥n</a>
                    </div>
                `);
                return;
            }

            $contenido.html('<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Cargando distribuidores...</p></div>');

            makeCNE_API_Call("https://api.cne.cl/api/v4/combustible/vehicular/distribuidores")
                .done(function(response) {
                    distribuidoresData = response; // Guardar datos globalmente
                    mostrarDistribuidores(response);
                })
                .fail(function(jqXHR) {
                    let mensaje = '';
                    if (jqXHR.status === 401) {
                        mensaje = 'Token inv√°lido o expirado. <a href="../login.html" class="alert-link">Iniciar sesi√≥n nuevamente</a>.';
                    } else if (jqXHR.status === 0) {
                        mensaje = 'Error de conexi√≥n o CORS. Verifica que est√©s usando un servidor web.';
                    } else {
                        mensaje = `Error ${jqXHR.status}: ${jqXHR.statusText}`;
                    }
                    
                    $contenido.html(`
                        <div class="alert alert-danger">
                            <h6>Error al cargar distribuidores</h6>
                            <p>${mensaje}</p>
                            <small>Respuesta del servidor: ${jqXHR.responseText || 'No hay respuesta'}</small>
                        </div>
                    `);
                    $contador.text('0 distribuidores');
                });
        }

        function mostrarDistribuidores(distribuidores) {
            const $contenido = $('#contenido-distribuidores');
            const $contador = $('#contador-distribuidores');
            
            let html = '';
            let contador = 0;
            
            if (Array.isArray(distribuidores) && distribuidores.length > 0) {
                // Aplicar ordenamiento si est√° activado
                let datosMostrar = [...distribuidores];
                if ($('#ordenar-alfabetico').is(':checked')) {
                    datosMostrar.sort((a, b) => {
                        const nombreA = a.nombre_distribuidor || '';
                        const nombreB = b.nombre_distribuidor || '';
                        return nombreA.localeCompare(nombreB);
                    });
                }

                html = `
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nombre del Distribuidor</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                $.each(datosMostrar, function(i, distribuidor) {
                    contador++;
                    const nombre = distribuidor.nombre_distribuidor || 'Nombre no disponible';
                    
                    html += `
                        <tr>
                            <td><strong>${contador}</strong></td>
                            <td>
                                <span class="distribuidor-nombre">${nombre}</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="verDetalleDistribuidor('${nombre.replace(/'/g, "\\'")}')">
                                    Ver Detalle
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6>üìà Resumen:</h6>
                        <p>Se encontraron <strong>${contador}</strong> distribuidores diferentes en el sistema.</p>
                    </div>
                `;
            } else {
                html = '<div class="alert alert-warning">No se encontraron distribuidores o el token es inv√°lido.</div>';
            }
            
            $contenido.html(html);
            $contador.text(contador + ' distribuidores');
        }

        function filtrarDistribuidores() {
            const filtro = $('#buscar-distribuidor').val().toLowerCase().trim();
            
            if (!filtro) {
                mostrarDistribuidores(distribuidoresData);
                return;
            }

            const filtrados = distribuidoresData.filter(distribuidor => {
                const nombre = distribuidor.nombre_distribuidor || '';
                return nombre.toLowerCase().includes(filtro);
            });

            mostrarDistribuidores(filtrados);
        }

        function verDetalleDistribuidor(nombre) {
            // Aqu√≠ podr√≠as implementar una llamada a otro endpoint
            // o mostrar informaci√≥n adicional sobre el distribuidor
            alert(`Distribuidor seleccionado: ${nombre}\n\n‚ö†Ô∏è Para m√°s informaci√≥n, consulta la documentaci√≥n oficial de la API CNE o usa otros endpoints disponibles.`);
        }

        // Tambi√©n necesitamos actualizar la funci√≥n en el dashboard
        function cargarResumenDistribuidores() {
            const token = localStorage.getItem('cne_api_token');
            if (!token) return;

            $.ajax({
                url: "https://api.cne.cl/api/v4/combustible/vehicular/distribuidores",
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
            .done(function(response) {
                $('#contador-distribuidores').text(response.length || 0);
                
                let html = '';
                if (Array.isArray(response) && response.length > 0) {
                    html = '<div class="list-group">';
                    $.each(response.slice(0, 5), function(i, distribuidor) {
                        html += `
                            <div class="list-group-item">
                                <strong>${distribuidor.nombre_distribuidor || 'N/A'}</strong>
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (response.length > 5) {
                        html += `<div class="text-center mt-2"><small class="text-muted">+${response.length - 5} m√°s distribuidores</small></div>`;
                    }
                } else {
                    html = '<p class="text-warning">No se pudieron cargar los distribuidores</p>';
                }
                $('#vista-distribuidores').html(html);
            })
            .fail(function() {
                $('#contador-distribuidores').text('0');
                $('#vista-distribuidores').html('<p class="text-danger">Error al cargar distribuidores</p>');
            });
        }
    </script>
</body>
</html>