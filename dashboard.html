<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API CNE - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="my-4">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="text-primary">üöÄ Dashboard API CNE</h1>
                <button class="btn btn-outline-danger" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
            </div>
            <p class="text-muted">Vista consolidada de datos de la API CNE</p>
        </header>

        <!-- Estado del Token -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">‚úÖ Sesi√≥n Activa</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p><strong>Token de acceso:</strong></p>
                        <code class="token-display d-block bg-light p-2 rounded text-break"></code>
                    </div>
                    <div class="col-md-4 text-end">
                        <p class="text-muted">V√°lido para endpoints protegidos</p>
                        <a href="index.html" class="btn btn-primary">Ir al Inicio</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen R√°pido -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h2 id="contador-estaciones">0</h2>
                        <p class="mb-0">Estaciones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <h2 id="contador-distribuidores">0</h2>
                        <p class="mb-0">Distribuidores</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h2 id="contador-combustibles">0</h2>
                        <p class="mb-0">Tipos Combustible</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center bg-warning text-dark">
                    <div class="card-body">
                        <h2 id="contador-regiones">0</h2>
                        <p class="mb-0">Regiones</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones R√°pidas -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">‚ö° Acciones R√°pidas</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="examples/estaciones.html" class="btn btn-outline-primary w-100">
                            ‚õΩ Ver Estaciones
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="examples/distribuidores.html" class="btn btn-outline-info w-100">
                            üè¢ Ver Distribuidores
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="examples/tipos-combustibles.html" class="btn btn-outline-success w-100">
                            ‚õΩ Tipos Combustible
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-warning w-100" onclick="cargarDatosCompletos()">
                            üìä Cargar Todo
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Previa de Datos -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">√öltimas Estaciones</h6>
                    </div>
                    <div class="card-body">
                        <div id="vista-estaciones" class="text-center">
                            <p class="text-muted">Cargando estaciones...</p>
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">Distribuidores</h6>
                    </div>
                    <div class="card-body">
                        <div id="vista-distribuidores" class="text-center">
                            <p class="text-muted">Cargando distribuidores...</p>
                            <div class="spinner-border text-success" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tipos de Combustible -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">Tipos de Combustible Disponibles</h6>
            </div>
            <div class="card-body">
                <div id="vista-combustibles" class="text-center">
                    <p class="text-muted">Cargando tipos de combustible...</p>
                    <div class="spinner-border text-warning" role="status"></div>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n de Uso -->
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">‚ÑπÔ∏è Informaci√≥n de Uso</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Endpoints Accesibles:</h6>
                        <ul class="list-unstyled">
                            <li>‚úÖ <code>/api/v4/estaciones</code></li>
                            <li>‚úÖ <code>/api/v4/combustible/vehicular/distribuidores</code></li>
                            <li>‚úÖ <code>/api/v4/combustible/vehicular/tiposcombustibles</code></li>
                            <li>‚úÖ <code>/api/region</code> (P√∫blico)</li>
                            <li>‚úÖ <code>/api/comuna/{id}</code> (P√∫blico)</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Pr√≥ximos Pasos:</h6>
                        <ul>
                            <li>Explora los ejemplos espec√≠ficos</li>
                            <li>Revisa el c√≥digo de cada endpoint</li>
                            <li>Prueba los filtros y funcionalidades</li>
                            <li>Implementa en tus propios proyectos</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        $(function() {
            // Verificar autenticaci√≥n
            const token = localStorage.getItem('cne_api_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // Mostrar token
            $('.token-display').text(token);

            // Cargar datos del dashboard
            cargarDatosCompletos();
        });

        function cargarDatosCompletos() {
            cargarResumenEstaciones();
            cargarResumenDistribuidores();
            cargarResumenCombustibles();
            cargarRegiones();
        }

        function cargarResumenEstaciones() {
            const token = localStorage.getItem('cne_api_token');
            if (!token) return;

            $.ajax({
                url: "https://api.cne.cl/api/v4/estaciones",
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
            .done(function(response) {
                $('#contador-estaciones').text(response.length || 0);
                
                let html = '';
                if (Array.isArray(response) && response.length > 0) {
                    html = '<div class="list-group">';
                    $.each(response.slice(0, 5), function(i, estacion) {
                        html += `
                            <div class="list-group-item">
                                <strong>${estacion.razon_social || 'N/A'}</strong><br>
                                <small class="text-muted">${estacion.ubicacion?.direccion || 'Direcci√≥n no disponible'}</small>
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (response.length > 5) {
                        html += `<div class="text-center mt-2"><small class="text-muted">+${response.length - 5} m√°s estaciones</small></div>`;
                    }
                } else {
                    html = '<p class="text-warning">No se pudieron cargar las estaciones</p>';
                }
                $('#vista-estaciones').html(html);
            })
            .fail(function() {
                $('#contador-estaciones').text('0');
                $('#vista-estaciones').html('<p class="text-danger">Error al cargar estaciones</p>');
            });
        }

        function cargarResumenDistribuidores() {
            const token = localStorage.getItem('cne_api_token');
            if (!token) return;

            $.ajax({
                url: "https://api.cne.cl/api/v4/combustible/vehicular/distribuidores",
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
            .done(function(response) {
                $('#contador-distribuidores').text(response.length || 0);
                
                let html = '';
                if (Array.isArray(response) && response.length > 0) {
                    html = '<div class="list-group">';
                    $.each(response.slice(0, 5), function(i, distribuidor) {
                        html += `
                            <div class="list-group-item">
                                <strong>${distribuidor.nombre || 'N/A'}</strong><br>
                                <small class="text-muted">${distribuidor.comuna || 'Comuna no disponible'}</small>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html = '<p class="text-warning">No se pudieron cargar los distribuidores</p>';
                }
                $('#vista-distribuidores').html(html);
            })
            .fail(function() {
                $('#contador-distribuidores').text('0');
                $('#vista-distribuidores').html('<p class="text-danger">Error al cargar distribuidores</p>');
            });
        }

        function cargarResumenCombustibles() {
            const token = localStorage.getItem('cne_api_token');
            if (!token) return;

            $.ajax({
                url: "https://api.cne.cl/api/v4/combustible/vehicular/tiposcombustibles",
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
            .done(function(response) {
                $('#contador-combustibles').text(response.length || 0);
                
                let html = '';
                if (Array.isArray(response) && response.length > 0) {
                    html = '<div class="d-flex flex-wrap gap-2">';
                    $.each(response, function(i, combustible) {
                        html += `
                            <span class="badge bg-primary bg-opacity-25 text-dark p-2">
                                ${combustible.nombre || 'N/A'}
                            </span>
                        `;
                    });
                    html += '</div>';
                } else {
                    html = '<p class="text-warning">No se pudieron cargar los tipos de combustible</p>';
                }
                $('#vista-combustibles').html(html);
            })
            .fail(function() {
                $('#contador-combustibles').text('0');
                $('#vista-combustibles').html('<p class="text-danger">Error al cargar tipos de combustible</p>');
            });
        }

        function cargarRegiones() {
            $.ajax({
                url: "https://api.cne.cl/api/region",
                method: "GET"
            })
            .done(function(response) {
                $('#contador-regiones').text(response.length || 0);
            })
            .fail(function() {
                $('#contador-regiones').text('0');
            });
        }

        function cerrarSesion() {
            localStorage.removeItem('cne_api_token');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>